; TASKING C166/ST10 C compiler v8.7r1 Build 775
; options: -e -Id:\programme\tasking\c166 v8.7r1\include -x2 -Bhoeufmknladij -OB
;          -OE -zswitch_tabmem_default -zautobitastruct-4 -zautobita-0 -FSC -A1
;          -zvolatile_union -O0 -g -newerr -s -i0 -Ms
$DEBUG
$NOLOCALS
$EXTEND2
$NOMOD166
$STDNAMES(regsuper10bo.def)
$EXTMAC
$CASE
$NOEXPANDREGBANK
$MODEL(SMALL)
	NAME	GPT2_C
	?SYMB	'gpt2.c',32,80,16
	?SYMB	'',1,82,0
	?SYMB	'80166',0,84,0
	?SYMB	'',0,81,0
	?SYMB	'void',00H,45,1
	?SYMB	'char',080000H,45,2
	?SYMB	'unsigned char',080000H,45,3
	?SYMB	'short',0100000H,45,4
	?SYMB	'unsigned short',0100000H,45,5
	?SYMB	'long',0200000H,45,6
	?SYMB	'unsigned long',0200000H,45,7
	?SYMB	'float',0200000H,45,10
	?SYMB	'double',0400000H,45,11
	?SYMB	'int',0100000H,45,16
	?SYMB	'unsigned int',0100000H,45,18
	?SYMB	'bit',010000H,7,256
	?SYMB	'gpt2.c',0,29,1
	?SYMB	'',0,86,1
; gpt2.c      1	//****************************************************************************
; gpt2.c      2	// @Module        General Purpose Timer Unit (GPT2)
; gpt2.c      3	// @Filename      GPT2.C
; gpt2.c      4	// @Project       DAvE_config.dav
; gpt2.c      5	//----------------------------------------------------------------------------
; gpt2.c      6	// @Controller    Infineon XE167F-96F66
; gpt2.c      7	//
; gpt2.c      8	// @Compiler      Tasking Classic
; gpt2.c      9	//
; gpt2.c     10	// @Codegenerator 2.2
; gpt2.c     11	//
; gpt2.c     12	// @Description   This file contains functions that use the GPT2 module.
; gpt2.c     13	//
; gpt2.c     14	//----------------------------------------------------------------------------
; gpt2.c     15	// @Date          30.09.2021 14:42:54
; gpt2.c     16	//
; gpt2.c     17	//****************************************************************************
; gpt2.c     18	
; gpt2.c     19	// USER CODE BEGIN (GPT2_General,1)
; gpt2.c     20	
; gpt2.c     21	// USER CODE END
; gpt2.c     22	
; gpt2.c     23	//****************************************************************************
; gpt2.c     24	// @Project Includes
; gpt2.c     25	//****************************************************************************
; gpt2.c     26	
; gpt2.c     27	#include "MAIN.H"
	?SYMB	'MAIN.H',0,29,2
	?SYMB	'',0,86,2
	?SYMB	'XE16xREGS.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'SCS.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'T$2',0,14,257
	?SYMB	'SCS_EXTCLK_F_SYS',0,33,257
	?SYMB	'SCS_EXTCLK_F_OUT',1,33,257
	?SYMB	'SCS_EXTCLK_F_PLL',2,33,257
	?SYMB	'SCS_EXTCLK_F_OSC',3,33,257
	?SYMB	'SCS_EXTCLK_F_WU',4,33,257
	?SYMB	'SCS_EXTCLK_F_TCK',5,33,257
	?SYMB	'SCS_EXTCLK_F_OSC_FL',6,33,257
	?SYMB	'SCS_EXTCLK_F_RTC',8,33,257
	?SYMB	'',16,16,0
	?SYMB	'SCS_EXTCLK_Type',257,13,258
	?SYMB	'',0,86,2
	?SYMB	'IO.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'GPT1.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'GPT2.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'CCU62.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'CCU63.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'',0,86,2
	?SYMB	'ADC0.H',0,29,3
	?SYMB	'',0,86,3
	?SYMB	'ubyte',3,13,259
	?SYMB	'',0,86,2
	?SYMB	'',0,86,1
; gpt2.c     28	
; gpt2.c     29	// USER CODE BEGIN (GPT2_General,2)
; gpt2.c     30	
; gpt2.c     31	// USER CODE END
; gpt2.c     32	
; gpt2.c     33	//****************************************************************************
; gpt2.c     34	// @Macros
; gpt2.c     35	//****************************************************************************
; gpt2.c     36	
; gpt2.c     37	// USER CODE BEGIN (GPT2_General,3)
; gpt2.c     38	
; gpt2.c     39	// USER CODE END
; gpt2.c     40	
; gpt2.c     41	//****************************************************************************
; gpt2.c     42	// @Defines
; gpt2.c     43	//****************************************************************************
; gpt2.c     44	
; gpt2.c     45	// USER CODE BEGIN (GPT2_General,4)
; gpt2.c     46	
; gpt2.c     47	// USER CODE END
; gpt2.c     48	
; gpt2.c     49	//****************************************************************************
; gpt2.c     50	// @Typedefs
; gpt2.c     51	//****************************************************************************
; gpt2.c     52	
; gpt2.c     53	// USER CODE BEGIN (GPT2_General,5)
; gpt2.c     54	
; gpt2.c     55	// USER CODE END
; gpt2.c     56	
; gpt2.c     57	//****************************************************************************
; gpt2.c     58	// @Imported Global Variables
; gpt2.c     59	//****************************************************************************
; gpt2.c     60	
; gpt2.c     61	// USER CODE BEGIN (GPT2_General,6)
; gpt2.c     62	// Externe Globale Variablen von der Main.c übernehmen
; gpt2.c     63	extern const unsigned int ARRAY_SIZE;
; gpt2.c     64	extern unsigned int rampIndex;
; gpt2.c     65	extern volatile float velocity;
; gpt2.c     66	volatile unsigned int inc;
; gpt2.c     67	// USER CODE END
; gpt2.c     68	
; gpt2.c     69	//****************************************************************************
; gpt2.c     70	// @Global Variables
; gpt2.c     71	//****************************************************************************
; gpt2.c     72	
; gpt2.c     73	// USER CODE BEGIN (GPT2_General,7)
; gpt2.c     74	
; gpt2.c     75	// USER CODE END
; gpt2.c     76	
; gpt2.c     77	//****************************************************************************
; gpt2.c     78	// @External Prototypes
; gpt2.c     79	//****************************************************************************
; gpt2.c     80	
; gpt2.c     81	// USER CODE BEGIN (GPT2_General,8)
; gpt2.c     82	
; gpt2.c     83	// USER CODE END
; gpt2.c     84	
; gpt2.c     85	//****************************************************************************
; gpt2.c     86	// @Prototypes Of Local Functions
; gpt2.c     87	//****************************************************************************
; gpt2.c     88	
; gpt2.c     89	// USER CODE BEGIN (GPT2_General,9)
; gpt2.c     90	
; gpt2.c     91	// USER CODE END
; gpt2.c     92	
; gpt2.c     93	//****************************************************************************
; gpt2.c     94	// @Function      void GPT2_vInit(void)
; gpt2.c     95	//
; gpt2.c     96	//----------------------------------------------------------------------------
; gpt2.c     97	// @Description   This is the initialization function of the GPT2 function
; gpt2.c     98	//                library. It is assumed that the SFRs used by this library
; gpt2.c     99	//                are in reset state.
; gpt2.c    100	//
; gpt2.c    101	//----------------------------------------------------------------------------
; gpt2.c    102	// @Returnvalue   None
; gpt2.c    103	//
; gpt2.c    104	//----------------------------------------------------------------------------
; gpt2.c    105	// @Parameters    None
; gpt2.c    106	//
; gpt2.c    107	//----------------------------------------------------------------------------
; gpt2.c    108	// @Date          30.09.2021
; gpt2.c    109	//
; gpt2.c    110	//****************************************************************************
; gpt2.c    111	
; gpt2.c    112	// USER CODE BEGIN (Init,1)
; gpt2.c    113	
; gpt2.c    114	// USER CODE END
; gpt2.c    115	
; gpt2.c    116	void GPT2_vInit(void) {
GPT2_1_PR	SECTION	CODE WORD PUBLIC 'CPROGRAM'
	?LINE	116
	PUBLIC	_GPT2_vInit
	?SYMB	'GPT2_vInit',_GPT2_vInit,37,1
	?SYMB	'',116,8,34
	?SYMB	'uword',18,13,261
_GPT2_vInit	PROC	FAR
	?SYMB	'',00H,95,0
; Locals:
; 
; Statics:
; 
; CSEs:
; 
; gpt2.c    117		// USER CODE BEGIN (Init,2)
; gpt2.c    118	
; gpt2.c    119		// USER CODE END
; gpt2.c    120		///  -----------------------------------------------------------------------
; gpt2.c    121		///  Configuration of Timer Block Prescaler 1:
; gpt2.c    122		///  -----------------------------------------------------------------------
; gpt2.c    123		GPT12E_KSCCFG = 0x0003;	 // Module Enable
	?LINE	123
	MOV	R12,#03h
	MOV	0FE1Ch,R12
; gpt2.c    124	
; gpt2.c    125		_nop();	 // one cycle delay
	?LINE	125
	NOP
; gpt2.c    126	
; gpt2.c    127		_nop();	 // one cycle delay
	?LINE	127
	NOP
; gpt2.c    128	
; gpt2.c    129		///  -----------------------------------------------------------------------
; gpt2.c    130		///  Configuration of Timer Block Prescaler 2:
; gpt2.c    131		///  -----------------------------------------------------------------------
; gpt2.c    132		///  - prescaler for timer block 2 is 2
; gpt2.c    133	
; gpt2.c    134		///  -----------------------------------------------------------------------
; gpt2.c    135		///  Configuration of the GPT2 Core Timer 5:
; gpt2.c    136		///  -----------------------------------------------------------------------
; gpt2.c    137		///  - timer 5 works in timer mode
; gpt2.c    138		///  - prescaler factor is 2
; gpt2.c    139		///  - up/down control bit is reset
; gpt2.c    140		///  - external up/down control is disabled
; gpt2.c    141		///  - timer 5 run bit is reset
; gpt2.c    142		///  - timer 5 remote control is disabled
; gpt2.c    143	
; gpt2.c    144		GPT12E_T5CON = 0x0000;	// load timer 5 control register
	?LINE	144
	MOV	R12,#00h
	MOV	0FF46h,R12
; gpt2.c    145		GPT12E_T5 = 0xFFFF;		// load timer 5 register
	?LINE	145
	MOV	R12,#0FFFFh
	MOV	0FE46h,R12
; gpt2.c    146	
; gpt2.c    147		///  -----------------------------------------------------------------------
; gpt2.c    148		///  Configuration of the GPT2 Core Timer 6:
; gpt2.c    149		///  -----------------------------------------------------------------------
; gpt2.c    150		///  - timer 6 works in timer mode
; gpt2.c    151		///  - prescaler factor is 8
; gpt2.c    152		///  - up/down control bit is reset
; gpt2.c    153		///  - external up/down control is disabled
; gpt2.c    154		///  - alternate output function T6OUT (P6.2) is disabled
; gpt2.c    155		///  - alternate output function T6OUT (P7.0) is disabled
; gpt2.c    156		///  - timer 6 output toggle latch (T6OTL) is set to 0
; gpt2.c    157		///  - timer 6 run bit is reset
; gpt2.c    158		///  - timer 6 is not cleared on a capture
; gpt2.c    159	
; gpt2.c    160		GPT12E_T6CON = 0x0802;	// load timer 6 control register
	?LINE	160
	MOV	R12,#0802h
	MOV	0FF48h,R12
; gpt2.c    161		GPT12E_T6 = 0x0218;		// load timer 6 register
	?LINE	161
	MOV	R12,#0218h
	MOV	0FE48h,R12
; gpt2.c    162	
; gpt2.c    163		///  -----------------------------------------------------------------------
; gpt2.c    164		///  Configuration of the GPT2 CAPREL:
; gpt2.c    165		///  -----------------------------------------------------------------------
; gpt2.c    166		///  - capture T5 into CAPREL is disabled
; gpt2.c    167		///  - capture trigger from pin CAPIN
; gpt2.c    168		///  - capure is disabled
; gpt2.c    169		///  - timer 5 is not cleared on a capture
; gpt2.c    170		///  - timer 5 is just captured without any correction
; gpt2.c    171	
; gpt2.c    172		GPT12E_T5CON |= 0x0000;	 // load timer 5 control register
	?LINE	172
	MOV	R12,#0FF46h
	MOV	R12,[R12]
; gpt2.c    173		GPT12E_CAPREL = 0x0218;	 // load CAPREL register
	?LINE	173
	MOV	R12,#0218h
	MOV	0FE4Ah,R12
; gpt2.c    174	
; gpt2.c    175		///  -----------------------------------------------------------------------
; gpt2.c    176		///  Configuration of the used GPT2 Port Pins:
; gpt2.c    177		///  -----------------------------------------------------------------------
; gpt2.c    178		///  - P5.3 is used for  GPT12E Timer2 Count input(T3IN)
; gpt2.c    179	
; gpt2.c    180		///  -----------------------------------------------------------------------
; gpt2.c    181		///  Configuration of the used GPT2 Interrupts:
; gpt2.c    182		///  -----------------------------------------------------------------------
; gpt2.c    183		///  timer 6 service request node configuration:
; gpt2.c    184		///  - timer 6 interrupt priority level (ILVL) = 14
; gpt2.c    185		///  - timer 6 interrupt group level (GLVL) = 0
; gpt2.c    186		///  - timer 6 group priority extension (GPX) = 0
; gpt2.c    187	
; gpt2.c    188		GPT12E_T6IC = 0x0078;
	?LINE	188
	MOV	R12,#078h
	MOV	0FF68h,R12
; gpt2.c    189	
; gpt2.c    190		///  Use PEC channel 0 for GPT2 T6 INT:
; gpt2.c    191		///  - normal interrupt
; gpt2.c    192		///  - pointers are not modified
; gpt2.c    193		///  - transfer a word
; gpt2.c    194		///  - service End of PEC interrrupt by a EOP interrupt node is disabled
; gpt2.c    195		///  - channel link mode is disabled
; gpt2.c    196	
; gpt2.c    197		PECC0 = 0x0000;	 // load PECC0 control register
	?LINE	197
	MOV	R12,#00h
	MOV	0FEC0h,R12
; gpt2.c    198	
; gpt2.c    199		// USER CODE BEGIN (GPT2_Function,3)
; gpt2.c    200	
; gpt2.c    201		// USER CODE END
; gpt2.c    202	
; gpt2.c    203	}  //  End of function GPT2_viCAPREL
	?LINE	203
	RETS
_GPT2_vInit	ENDP
	?SYMB	'',$,17,203
; gpt2.c    204	
; gpt2.c    205	//****************************************************************************
; gpt2.c    206	// @Function      void GPT2_viTmr6(void)
; gpt2.c    207	//
; gpt2.c    208	//----------------------------------------------------------------------------
; gpt2.c    209	// @Description   This is the interrupt service routine for the GPT2 timer 6.
; gpt2.c    210	//                It is called up in the case of over or underflow of the
; gpt2.c    211	//                timer 6 register.
; gpt2.c    212	//
; gpt2.c    213	//                Please note that you have to add application specific code
; gpt2.c    214	//                to this function.
; gpt2.c    215	//
; gpt2.c    216	//----------------------------------------------------------------------------
; gpt2.c    217	// @Returnvalue   None
; gpt2.c    218	//
; gpt2.c    219	//----------------------------------------------------------------------------
; gpt2.c    220	// @Parameters    None
; gpt2.c    221	//
; gpt2.c    222	//----------------------------------------------------------------------------
; gpt2.c    223	// @Date          30.09.2021
; gpt2.c    224	//
; gpt2.c    225	//****************************************************************************
; gpt2.c    226	
; gpt2.c    227	// USER CODE BEGIN (Tmr6,1)
; gpt2.c    228	
; gpt2.c    229	// USER CODE END
; gpt2.c    230	
; gpt2.c    231	_interrupt(T6INT) void GPT2_viTmr6(void) {
	?SYMB	'GPT2_viTmr6',_GPT2_viTmr6,37,1
	?SYMB	'',231,8,16
_GPT2_viTmr6	PROC TASK GPT2_TASK INTNO GPT2_INUM = 024h
	?LINE	231
	?SYMB	'',00H,95,0
	MOV	GPT2_RB,R0
	SCXT	CP,#GPT2_RB
	SCXT	MDC,#010h
	PUSH	DPP0
	MOV	DPP0,#PAG ?BASE_DPP0
	NOP
	PUSH	DPP2
	MOV	DPP2,#PAG ?BASE_DPP2
	NOP
	PUSH	MDH
	PUSH	MDL
	PUSH	MSW
	PUSH	MAL
	PUSH	MAH
	PUSH	MCW
	SCXT	MRW,#00h
	PUSH	IDX0
	PUSH	IDX1
	EXTR	#01h
	PUSH	QX0
	EXTR	#01h
	PUSH	QX1
	EXTR	#01h
	PUSH	QR0
	EXTR	#01h
	PUSH	QR1
; Locals:
; 
; Statics:
; 
; CSEs:
; 
; gpt2.c    232		// USER CODE BEGIN (Tmr6,2)
; gpt2.c    233		// Index für den Programmablauf, größer 5251 damit der Programmablauf bei Überlauf
; gpt2.c    234		// der Variable RampIndex (16 Bit) nicht erneut von vorn startet
; gpt2.c    235		if (rampIndex < 5251) {
	?LINE	235
	MOV	R12,_rampIndex
	CMP	R12,#01483h
	JMPR	cc_UGE,_7
; gpt2.c    236			rampIndex++;
	?LINE	236
	MOV	R12,_rampIndex
	ADD	R12,#01h
	MOV	_rampIndex,R12
; gpt2.c    237		}
	?LINE	237
_7:
; gpt2.c    238	
; gpt2.c    239		// auslesen des GPT Timer 4 Registers
; gpt2.c    240		// Entspricht der Anzahl der Inkremente des Encoders in 8 ms
; gpt2.c    241		inc = GPT12E_T4;
	?LINE	241
	MOV	R12,0FE44h
	MOV	_inc,R12
; gpt2.c    242		// Berechnung der Geschwindigkeit durch Differenzbildung
; gpt2.c    243		velocity = (1000 * (float)inc) / (8);
	?LINE	243
	MOV	R4,_inc
	CALLS	SEG __cuf24r,__cuf24r
	MOV	R10,#0447Ah
	MOV	R11,#00h
	CALLS	SEG __mlf4r,__mlf4r
	MOV	R10,#04100h
	MOV	R11,#00h
	CALLS	SEG __dvf4r,__dvf4r
	MOV	_velocity,R4
	MOV	(_velocity+2),R5
; gpt2.c    244		// Umrechnung von inc/s zu 1/s
; gpt2.c    245		velocity = velocity / 2048;
	?LINE	245
	MOV	R4,_velocity
	MOV	R5,(_velocity+2)
	MOV	R10,#04500h
	MOV	R11,#00h
	CALLS	SEG __dvf4r,__dvf4r
	MOV	_velocity,R4
	MOV	(_velocity+2),R5
; gpt2.c    246		// zurücksetzen des Timer 4 Registers
; gpt2.c    247		GPT12E_T4 = 0;
	?LINE	247
	MOV	R12,#00h
	MOV	0FE44h,R12
; gpt2.c    248		// USER CODE END
; gpt2.c    249	
; gpt2.c    250	}  //  End of function GPT2_viTmr6
	?LINE	250
	EXTR	#01h
	POP	QR1
	EXTR	#01h
	POP	QR0
	EXTR	#01h
	POP	QX1
	EXTR	#01h
	POP	QX0
	POP	IDX1
	POP	IDX0
	POP	MRW
	POP	MCW
	POP	MAH
	POP	MAL
	POP	MSW
	POP	MDL
	POP	MDH
	POP	DPP2
	POP	DPP0
	POP	MDC
	POP	CP
	?LINE	250
	RETI
_GPT2_viTmr6	ENDP
	?SYMB	'',$,17,250
; gpt2.c    251	
; gpt2.c    252	// USER CODE BEGIN (GPT2_General,10)
; gpt2.c    253	
; gpt2.c    254	// USER CODE END
GPT2_1_PR	ENDS

GPT2_2_NB	SECTION	LDAT WORD PUBLIC 'CNEAR'
GPT2_2_NB_ENTRY	LABEL	BYTE
_inc	LABEL	WORD
	DS	2
	PUBLIC	_inc
	?SYMB	'inc',_inc,22,18
GPT2_2_NB	ENDS

C166_BSS	SECTION	PDAT WORD GLOBAL 'CINITROM'
	DW	05h,GPT2_2_NB_ENTRY,02h
C166_BSS	ENDS

$FLOAT(ANSI)
	EXTERN	_velocity:WORD
	EXTERN	_rampIndex:WORD
	EXTERN	__cuf24r:FAR
	EXTERN	__mlf4r:FAR
	EXTERN	__dvf4r:FAR
GPT2_RB	REGDEF	R0-R15
	END
